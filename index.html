<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stack House Builder</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: linear-gradient(to top, #87ceeb 0%, #a0d8f1 100%);
  touch-action: manipulation;
  font-family: sans-serif;
}

#game {
  position: relative;
  width: 100vw;
  height: 100vh;
}

.block {
  width: 80px;
  height: 80px;
  background: #8B4513;
  position: absolute;
  border-radius: 5px;
  border: 2px solid #654321;
  box-shadow: 0 5px 10px rgba(0,0,0,0.3);
  box-sizing: border-box;
}

.block::before, .block::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: #add8e6;
  border: 1px solid #333;
  top: 20px;
}

.block::before { left: 10px; }
.block::after { right: 10px; }

.line {
  width: 4px;
  height: 60px;
  background: black;
  position: absolute;
  top: 0;
}

#ground {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 50px;
  background: #654321;
  box-shadow: inset 0 5px 5px rgba(0,0,0,0.5);
}

#score {
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 24px;
  color: white;
}

#message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 36px;
  color: red;
  display: none;
  text-align: center;
}
</style>
</head>
<body>
<div id="game">
  <div id="ground"></div>
  <div id="score">0</div>
  <div id="message">Game Over<br>Appuyez pour recommencer</div>
</div>

<script>
const game = document.getElementById('game');
const scoreEl = document.getElementById('score');
const messageEl = document.getElementById('message');
const groundHeight = 50;

let blocks = [];
let currentBlock = null;
let isFalling = false;
let score = 0;

// Grue variables
let craneX = window.innerWidth / 2;
let craneSpeed = 2;
let craneDirection = 1;

// Création d’un bloc au-dessus du dernier bloc ou sur le sol
function createBlock() {
  const block = document.createElement('div');
  block.classList.add('block');

  let lastY = window.innerHeight - groundHeight - 80; // hauteur du sol par défaut
  if(blocks.length > 0){
    const lastBlock = blocks[blocks.length - 1];
    lastY = parseFloat(lastBlock.style.top) - 80; // placer le nouveau bloc au-dessus du dernier
  }

  block.style.top = '50px'; // départ grue
  block.style.left = craneX + 'px';

  // Ligne de la grue
  const line = document.createElement('div');
  line.classList.add('line');
  line.style.left = craneX + 38 + 'px';
  game.appendChild(line);

  block.line = line;
  block.targetY = lastY; // position finale sur le stack
  game.appendChild(block);
  currentBlock = block;
}

// Mouvement grue
function updateCrane() {
  if (!isFalling && currentBlock) {
    craneX += craneSpeed * craneDirection;
    if (craneX < 40 || craneX > window.innerWidth - 120) craneDirection *= -1;
    currentBlock.style.left = craneX + 'px';
    currentBlock.line.style.left = craneX + 38 + 'px';
  }
  requestAnimationFrame(updateCrane);
}

// Chute avec alignement
function fall() {
  if (!isFalling) return;

  let top = parseFloat(currentBlock.style.top);
  top += 6;
  currentBlock.style.top = top + 'px';

  currentBlock.style.transform = `translateX(-50%) rotate(${Math.sin(top/30)*5}deg)`;

  if(top >= currentBlock.targetY){
    isFalling = false;
    currentBlock.style.top = currentBlock.targetY + 'px';
    blocks.push(currentBlock);
    currentBlock.line.remove();
    score++;
    scoreEl.innerText = score;
    createBlock();
  } else {
    requestAnimationFrame(fall);
  }
}

// Game Over
function gameOver() {
  isFalling = false;
  messageEl.style.display = 'block';
}

// Recommencer
function restartGame() {
  blocks.forEach(b => b.remove());
  blocks = [];
  score = 0;
  scoreEl.innerText = score;
  messageEl.style.display = 'none';
  craneX = window.innerWidth / 2;
  craneDirection = 1;
  createBlock();
}

// Click ou touch
game.addEventListener('click', () => {
  if (messageEl.style.display === 'block') {
    restartGame();
    return;
  }
  if (!isFalling) {
    isFalling = true;
    fall();
  }
});

game.addEventListener('touchstart', e => {
  e.preventDefault();
  game.click();
});

// Initialisation
createBlock();
updateCrane();
</script>
</body>
</html>